name: build & test

on:
  push:
  pull_request:

jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.5"
          check-latest: true

      - name: go build
        run: go build -v ./...

      - name: go test (unit only)
        run: go test -v -race ./internal/...

      - name: go lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.6.2

  e2e:
    name: integration (docker-compose)
    runs-on: ubuntu-latest
    needs: unit
    timeout-minutes: 25
    env:
      COMPOSE_DOCKER_CLI_BUILD: "1"
      DOCKER_BUILDKIT: "1"
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: docker versions
        run: |
          docker version
          docker compose version

      - name: run e2e via Makefile
        run: make e2e

      - name: collect compose logs on failure
        if: failure()
        run: docker compose -f docker-compose.e2e.yaml logs --no-color > e2e-logs.txt || true

      - name: upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: e2e-logs.txt

      - name: ensure cleanup
        if: always()
        run: docker compose -f docker-compose.e2e.yaml down -v || true